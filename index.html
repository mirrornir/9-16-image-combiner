<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9:16批量图片拼接工具（字体颜色全自定义）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }
        body {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f1f1f1;
        }
        .container {
            background: #fff;
            padding: 40px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }
        .upload-area:hover {
            border-color: #1677ff;
            background-color: #f5faff;
        }
        .upload-area.active {
            border-color: #1677ff;
            background-color: #f5faff;
        }
        #fileInput {
            display: none;
        }
        .upload-tip {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .upload-subtip {
            color: #999;
            font-size: 14px;
            line-height: 1.5;
        }
        /* 扩展配置栏：字体/颜色/大小 */
        .setting-bar {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px 20px;
            align-items: center;
            justify-content: space-between;
        }
        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .setting-item label {
            font-size: 15px;
            color: #333;
            font-weight: 500;
            white-space: nowrap;
        }
        .setting-item input[type="text"],
        .setting-item select {
            width: 120px;
            padding: 8px 12px;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            font-size: 15px;
            outline: none;
        }
        .setting-item input[type="text"]:focus,
        .setting-item select:focus {
            border-color: #1677ff;
        }
        .setting-item input[type="range"] {
            width: 150px;
            cursor: pointer;
        }
        .setting-item input[type="color"] {
            width: 40px;
            height: 36px;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            cursor: pointer;
            padding: 2px;
        }
        .setting-item .num-size-tip {
            color: #666;
            font-size: 14px;
            width: 60px;
        }
        .file-count {
            font-size: 15px;
            color: #666;
            white-space: nowrap;
        }
        .ratio-tip {
            font-size: 14px;
            color: #1677ff;
            font-weight: 500;
            white-space: nowrap;
        }
        .btn-group {
            text-align: center;
            margin-bottom: 30px;
        }
        .btn {
            display: inline-block;
            padding: 14px 36px;
            background-color: #1677ff;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .btn:hover {
            background-color: #0d66e8;
        }
        .btn:disabled {
            background-color: #dcdcdc;
            cursor: not-allowed;
            color: #999;
        }
        .btn-clear {
            background-color: #fff;
            color: #666;
            border: 1px solid #dcdcdc;
        }
        .btn-clear:hover {
            background-color: #f5f5f5;
            color: #333;
        }
        /* 双进度条 */
        .progress-wrapper {
            margin-bottom: 30px;
            display: none;
        }
        .progress-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #e5e5e5;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #1677ff;
            width: 0%;
            transition: width 0.2s ease;
        }
        .result-area {
            display: none;
            margin-top: 20px;
        }
        .result-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 500;
        }
        .result-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .result-item {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .item-name {
            color: #333;
            font-size: 15px;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .download-link {
            display: inline-block;
            color: #1677ff;
            font-size: 14px;
            text-decoration: none;
            padding: 6px 12px;
            border: 1px solid #1677ff;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        .download-link:hover {
            background-color: #1677ff;
            color: #fff;
        }
        /* 响应式适配 */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            h1 {
                font-size: 20px;
            }
            .upload-area {
                padding: 40px 10px;
            }
            .btn {
                padding: 12px 24px;
                font-size: 14px;
                margin: 0 5px 10px;
            }
            .setting-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .setting-item {
                width: 100%;
                justify-content: space-between;
            }
            .setting-item input[type="range"] {
                width: 120px;
            }
        }
        /* 可选：引入特殊字体（示例：阿里巴巴普惠体，无需本地文件） */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        /* 如需添加自定义字体，在这里加@font-face即可，示例：
        /* 可选：引入特殊字体（示例：阿里巴巴普惠体，无需本地文件） */
/* 自定义字体引用 - 6款字体 */
@font-face {
    font-family: 'Asther';
    src: url('https://mirrornir.github.io/9-16-image-combiner/Asther-Regular.ttf') format('truetype');
}
@font-face {
    font-family: 'Honey Monly';
    src: url('https://mirrornir.github.io/9-16-image-combiner/Honey Monly.otf') format('opentype');
}
@font-face {
    font-family: 'Knive';
    src: url('https://mirrornir.github.io/9-16-image-combiner/Knive.otf') format('opentype');
}
@font-face {
    font-family: 'Sundries';
    src: url('https://mirrornir.github.io/9-16-image-combiner/Sundries-DEMO-NEW.otf') format('opentype');
}
@font-face {
    font-family: 'Accountant Signature';
    src: url('https://mirrornir.github.io/9-16-image-combiner/accountantsignature-rpxr6.ttf') format('truetype');
}
@font-face {
    font-family: 'Smooth Fantasy';
    src: url('https://mirrornir.github.io/9-16-image-combiner/smoothfantasypersonaluse-p7rd1.ttf') format('truetype');
}
    </style>
</head>
<body>
    <div class="container">
        <h1>9:16批量图片拼接工具（字体颜色全自定义）</h1>
        
        <!-- 上传区域 -->
        <div class="upload-area" id="uploadArea">
            <p class="upload-tip">点击或拖拽图片到此处上传（支持一次性上传200张内）</p>
            <p class="upload-subtip">支持JPG/PNG/BMP | 图片仅本地处理 | 非9:16图不变形居中填充 | 所有图片100%显示</p>
            <input type="file" id="fileInput" accept="image/*" multiple>
        </div>
        
        <!-- 扩展配置栏：初始数字+字体+颜色+大小 -->
        <div class="setting-bar">
            <div class="file-count" id="fileCount">已选择：0 张图片</div>
            
            <div class="setting-item">
                <label for="startNum">初始序号：</label>
                <input type="text" id="startNum" value="1" placeholder="正整数">
            </div>

            <div class="setting-item">
                <label for="fontFamily">数字字体：</label>
                <select id="fontFamily">
                    <option value="Microsoft YaHei, Arial">微软雅黑</option>
                    <option value="SimSun, serif">宋体</option>
                    <option value="SimHei, sans-serif">黑体</option>
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="Noto Sans SC, sans-serif">思源黑体</option>
                    <!-- 如需添加自定义字体，新增<option value="MyCustomFont">我的自定义字体</option>即可 -->
                    <!-- 新增6款自定义字体 -->
                     <option value="Asther">Asther</option>
                     <option value="Honey Monly">Honey Monly</option>
                     <option value="Knive">Knive</option>
                     <option value="Sundries">Sundries-DEMO-NEW</option>
                     <option value="Accountant Signature">Accountant Signature</option>
                     <option value="Smooth Fantasy">Smooth Fantasy</option>
                </select>
            </div>

            <div class="setting-item">
                <label for="fontColor">字体颜色：</label>
                <input type="color" id="fontColor" value="#ffffff">
            </div>

            <div class="setting-item">
                <label for="strokeColor">描边颜色：</label>
                <input type="color" id="strokeColor" value="#000000">
            </div>

            <div class="setting-item">
                <label for="numSize">数字大小：</label>
                <input type="range" id="numSize" min="0" max="30" step="0.5" value="12">
                <span class="num-size-tip" id="numSizeTip">12.0%</span>
            </div>
            
            <div class="ratio-tip">9:16不变形 | 中间偏下序号 | 每9张一组</div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="btn-group">
            <button class="btn" id="combineBtn" disabled>开始批量拼接</button>
            <button class="btn btn-clear" id="clearBtn">清空已选图片</button>
        </div>
        
        <!-- 双进度条 -->
        <div class="progress-wrapper" id="progressWrapper">
            <div class="progress-title">1. 图片处理进度（加序号+9:16适配）：</div>
            <div class="progress-container">
                <div class="progress-bar" id="processProgressBar"></div>
            </div>
            <div class="progress-title" style="margin-top: 10px;">2. 拼图绘制进度：</div>
            <div class="progress-container">
                <div class="progress-bar" id="combineProgressBar"></div>
            </div>
        </div>
        
        <!-- 拼接结果 -->
        <div class="result-area" id="resultArea">
            <h3 class="result-title">拼接结果（点击下载，严格9:16）：</h3>
            <div class="result-list" id="resultList"></div>
        </div>
    </div>

    <script>
        // 核心配置
        const CONFIG = {
            GROUP_NUM: 9,
            RATIO_W: 9,
            RATIO_H: 16,
            STROKE_RATIO: 0.03,
            NUM_POS_Y: 0.85,
            MAX_UPLOAD: 200,
            BASE_W: 900,
            BG_COLOR: '#ffffff'
        };

        // 全局变量
        let selectedFiles = [];
        let processedImages = [];
        
        // 页面元素（新增字体/颜色相关）
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileCount = document.getElementById('fileCount');
        const startNumInput = document.getElementById('startNum');
        const fontFamilySelect = document.getElementById('fontFamily');
        const fontColorInput = document.getElementById('fontColor');
        const strokeColorInput = document.getElementById('strokeColor');
        const numSizeSlider = document.getElementById('numSize');
        const numSizeTip = document.getElementById('numSizeTip');
        const combineBtn = document.getElementById('combineBtn');
        const clearBtn = document.getElementById('clearBtn');
        const progressWrapper = document.getElementById('progressWrapper');
        const processProgressBar = document.getElementById('processProgressBar');
        const combineProgressBar = document.getElementById('combineProgressBar');
        const resultArea = document.getElementById('resultArea');
        const resultList = document.getElementById('resultList');

        // 初始化
        function init() {
            // 1. 拖拽上传
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('active');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('active');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('active');
                e.dataTransfer.files.length && handleFiles(e.dataTransfer.files);
            });

            // 2. 点击上传
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => handleFiles(fileInput.files));

            // 3. 数字大小滑块
            numSizeSlider.addEventListener('input', () => {
                numSizeTip.textContent = `${numSizeSlider.value}%`;
            });

            // 4. 按钮事件
            combineBtn.addEventListener('click', startFullProcess);
            clearBtn.addEventListener('click', clearAllFiles);

            // 5. 初始数字校验
            startNumInput.addEventListener('input', () => {
                startNumInput.value = startNumInput.value.replace(/\D/g, '');
                if (startNumInput.value === '') startNumInput.value = 1;
            });
        }

        // 处理上传文件
        function handleFiles(files) {
            const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            if (imageFiles.length === 0) {
                alert('请选择有效的图片文件（JPG/PNG/BMP）！');
                return;
            }

            const totalAfterAdd = selectedFiles.length + imageFiles.length;
            if (totalAfterAdd > CONFIG.MAX_UPLOAD) {
                const addCount = CONFIG.MAX_UPLOAD - selectedFiles.length;
                selectedFiles = [...selectedFiles, ...imageFiles.slice(0, addCount)];
                alert(`最多支持上传200张图片，已为你截取前${CONFIG.MAX_UPLOAD}张！`);
            } else {
                selectedFiles = [...selectedFiles, ...imageFiles];
            }

            fileCount.textContent = `已选择：${selectedFiles.length} 张图片`;
            combineBtn.disabled = selectedFiles.length === 0;
        }

        // 清空所有
        function clearAllFiles() {
            selectedFiles = [];
            processedImages = [];
            fileInput.value = '';
            startNumInput.value = 1;
            fontFamilySelect.value = 'Microsoft YaHei, Arial';
            fontColorInput.value = '#ffffff';
            strokeColorInput.value = '#000000';
            numSizeSlider.value = 12;
            numSizeTip.textContent = '12.0%';
            fileCount.textContent = `已选择：0 张图片`;
            combineBtn.disabled = true;
            resultArea.style.display = 'none';
            resultList.innerHTML = '';
            progressWrapper.style.display = 'none';
            processProgressBar.style.width = '0%';
            combineProgressBar.style.width = '0%';
        }

        // 单张图片处理（新增字体/颜色自定义）
        function processSingleImage(file, number) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        try {
                            // 1. 9:16适配计算
                            const targetRatio = CONFIG.RATIO_W / CONFIG.RATIO_H;
                            const imgRatio = img.width / img.height;
                            let drawW, drawH, offsetX = 0, offsetY = 0;

                            if (imgRatio > targetRatio) {
                                drawH = img.height;
                                drawW = img.height * targetRatio;
                                offsetX = (img.width - drawW) / 2;
                            } else {
                                drawW = img.width;
                                drawH = img.width / targetRatio;
                                offsetY = (img.height - drawH) / 2;
                            }

                            // 2. 创建画布
                            const baseH = (CONFIG.BASE_W / CONFIG.RATIO_W) * CONFIG.RATIO_H;
                            const canvas = document.createElement('canvas');
                            canvas.width = CONFIG.BASE_W;
                            canvas.height = baseH;
                            const ctx = canvas.getContext('2d');

                            // 3. 填充背景
                            ctx.fillStyle = CONFIG.BG_COLOR;
                            ctx.fillRect(0, 0, canvas.width, canvas.height);

                            // 4. 绘制原图
                            ctx.drawImage(
                                img,
                                offsetX, offsetY, drawW, drawH,
                                0, 0, canvas.width, canvas.height
                            );

                            // 5. 自定义序号样式（核心修改）
                            const numSizeRatio = parseFloat(numSizeSlider.value) / 100;
                            const fontSize = baseH * numSizeRatio;
                            const strokeWidth = fontSize * CONFIG.STROKE_RATIO;

                            // 获取用户选择的字体/颜色
                            const fontFamily = fontFamilySelect.value;
                            const fontColor = fontColorInput.value;
                            const strokeColor = strokeColorInput.value;

                            // 设置序号样式（自定义字体+颜色）
                            ctx.font = `normal ${fontSize}px ${fontFamily}`; // 自定义字体
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillStyle = fontColor; // 自定义字体颜色
                            ctx.strokeStyle = strokeColor; // 自定义描边颜色
                            ctx.lineWidth = strokeWidth;

                            // 序号位置
                            const x = canvas.width / 2;
                            const y = canvas.height * CONFIG.NUM_POS_Y;
                            const text = number.toString();

                            // 绘制序号
                            ctx.strokeText(text, x, y);
                            ctx.fillText(text, x, y);

                            // 6. 转换为Blob
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    resolve({
                                        blob: blob,
                                        width: canvas.width,
                                        height: canvas.height,
                                        number: number
                                    });
                                } else {
                                    reject(new Error(`图片${file.name}转换失败`));
                                }
                            }, 'image/jpeg', 1.0);
                        } catch (err) {
                            reject(new Error(`图片${file.name}处理失败：${err.message}`));
                        }
                    };

                    img.onerror = () => {
                        reject(new Error(`图片${file.name}加载失败，请检查文件是否损坏`));
                    };

                    img.src = e.target.result;
                };

                reader.onerror = () => {
                    reject(new Error(`文件${file.name}读取失败`));
                };

                reader.readAsDataURL(file);
            });
        }

        // 批量处理所有图片
        async function batchProcessImages(startNum) {
            processedImages = [];
            const total = selectedFiles.length;
            
            for (let i = 0; i < total; i++) {
                try {
                    const currentNum = startNum + i;
                    const processedImg = await processSingleImage(selectedFiles[i], currentNum);
                    processedImages.push(processedImg);
                } catch (err) {
                    console.warn(err.message);
                    alert(err.message + '，已跳过该图片继续处理');
                }
                
                const progress = ((i + 1) / total) * 100;
                processProgressBar.style.width = `${progress}%`;
            }
            
            if (processedImages.length === 0) {
                throw new Error('没有可拼接的有效图片');
            }
        }

        // 拼接单组图片
        function combineSingleGroup(groupImages, groupIdx, startNum, totalFiles) {
            return new Promise((resolve) => {
                const singleW = CONFIG.BASE_W;
                const singleH = (CONFIG.BASE_W / CONFIG.RATIO_W) * CONFIG.RATIO_H;
                const combineW = singleW * 3;
                const combineH = singleH * 3;

                const canvas = document.createElement('canvas');
                canvas.width = combineW;
                canvas.height = combineH;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = CONFIG.BG_COLOR;
                ctx.fillRect(0, 0, combineW, combineH);

                let loadedCount = 0;
                const totalGroupImages = groupImages.length;

                groupImages.forEach((imgData, idx) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        const col = idx % 3;
                        const row = Math.floor(idx / 3);
                        const x = col * singleW;
                        const y = row * singleH;
                        ctx.drawImage(img, x, y, singleW, singleH);

                        loadedCount++;
                        if (loadedCount === totalGroupImages) {
                            canvas.toBlob((blob) => {
                                const gStart = startNum + groupIdx * CONFIG.GROUP_NUM;
                                const gEnd = Math.min(
                                    startNum + (groupIdx + 1) * CONFIG.GROUP_NUM - 1,
                                    startNum + totalFiles - 1
                                );
                                const fileName = `9:16拼接组${groupIdx + 1}（${gStart}-${gEnd}号）.jpg`;
                                resolve({
                                    fileName: fileName,
                                    downloadUrl: URL.createObjectURL(blob)
                                });
                            }, 'image/jpeg', 1.0);
                        }
                    };

                    img.onerror = () => {
                        loadedCount++;
                        if (loadedCount === totalGroupImages) {
                            canvas.toBlob((blob) => {
                                const gStart = startNum + groupIdx * CONFIG.GROUP_NUM;
                                const gEnd = Math.min(
                                    startNum + (groupIdx + 1) * CONFIG.GROUP_NUM - 1,
                                    startNum + totalFiles - 1
                                );
                                const fileName = `9:16拼接组${groupIdx + 1}（${gStart}-${gEnd}号）.jpg`;
                                resolve({
                                    fileName: fileName,
                                    downloadUrl: URL.createObjectURL(blob)
                                });
                            }, 'image/jpeg', 1.0);
                        }
                    };

                    img.src = URL.createObjectURL(imgData.blob);
                });
            });
        }

        // 批量拼接所有组
        async function batchCombineImages(startNum) {
            const totalProcessed = processedImages.length;
            const groupCount = Math.ceil(totalProcessed / CONFIG.GROUP_NUM);
            const results = [];

            for (let groupIdx = 0; groupIdx < groupCount; groupIdx++) {
                const start = groupIdx * CONFIG.GROUP_NUM;
                const end = Math.min((groupIdx + 1) * CONFIG.GROUP_NUM, totalProcessed);
                const groupImages = processedImages.slice(start, end);

                const groupResult = await combineSingleGroup(
                    groupImages, 
                    groupIdx, 
                    startNum, 
                    selectedFiles.length
                );
                results.push(groupResult);

                const progress = ((groupIdx + 1) / groupCount) * 100;
                combineProgressBar.style.width = `${progress}%`;
            }

            return results;
        }

        // 主流程
        async function startFullProcess() {
            let startNum = parseInt(startNumInput.value) || 1;
            startNum = Math.max(startNum, 1);
            startNumInput.value = startNum;

            resultArea.style.display = 'none';
            resultList.innerHTML = '';
            progressWrapper.style.display = 'block';
            processProgressBar.style.width = '0%';
            combineProgressBar.style.width = '0%';
            combineBtn.disabled = true;

            try {
                await batchProcessImages(startNum);
                const results = await batchCombineImages(startNum);

                resultArea.style.display = 'block';
                results.forEach(res => {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <p class="item-name">${res.fileName}</p>
                        <a href="${res.downloadUrl}" download="${res.fileName}" class="download-link">点击下载</a>
                    `;
                    resultList.appendChild(item);
                });

                alert(`拼接完成！共处理${processedImages.length}张图片，生成${results.length}组拼图`);
            } catch (err) {
                alert(`拼接失败：${err.message}`);
            } finally {
                combineBtn.disabled = false;
                setTimeout(() => {
                    progressWrapper.style.display = 'none';
                }, 5000);
            }
        }

        // 页面加载完成初始化
        window.onload = init;
    </script>
</body>
</html>
